# designed for tmux >= 3.2

unbind C-b
set -g prefix C-y
bind-key C-y send-prefix

# works for me...
# "screen-256color" does not
set-option -s default-terminal "xterm-256color"

set -g mouse on

# fast escape in vim
set -sg escape-time 0

set -g focus-events on
set -ag terminal-features "focus"

set-option -g history-limit 262144

# longer than my key-repeat so holding down buttons will repeat the command
set-option -g repeat-time 600

# show error messages longer
set-option -g display-time 1500

unbind '"'
unbind %
# open panes in current folder
bind-key -T prefix | split-window -h -c "#{pane_current_path}"
bind-key -T prefix - split-window -v -c "#{pane_current_path}"

# windows may not be automatically renamed
set-option -g allow-rename off

# disable dragging panes
unbind-key -n MouseDrag1Border

# navigation shortcuts mapped to <cmd>
# see iterm: profile->keys->key mappings
bind-key -T root S-F1 select-pane -L   # code: ^[[1;2P  mapped to: <cmd>+<left>
bind-key -T root S-F2 select-pane -R   # code: ^[[1;2Q  mapped to: <cmd>+<right>
bind-key -T root S-F3 select-pane -U   # code: ^[[1;2R  mapped to: <cmd>+<up>
bind-key -T root S-F4 select-pane -D   # code: ^[[1;2S  mapped to: <cmd>+<down>
bind-key -T root S-F5 previous-window  # code: ^[[15;2~ mapped to: <ctrl>+<cmd>+<left>
bind-key -T root S-F6 next-window      # code: ^[[17;2~ mapped to: <ctrl>+<cmd>+<right>
bind-key -T root S-F7 switch-client -p # code: ^[[18;2~ mapped to: <ctrl>+<alt>+<cmd>+<left>
bind-key -T root S-F8 switch-client -n # code: ^[[19;2~ mapped to: <ctrl>+<alt>+<cmd>+<right>
#unbind session switch
unbind (
unbind )

bind-key -T prefix M-F4 command-prompt -p "New Session:" "new -s %%%" # code ^[[1;3S mapped to: <ctrl>+<alt>+c

# print pane size while resizing
bind-key -r -T prefix C-Up    resize-pane -U \; display '#{pane_width}x#{pane_height}'


bind-key -T prefix ß display '#{pane_width}x#{pane_height}'

set -g @scroll-speed-num-lines-per-scroll 1

# allows to scroll in alternate screen apps which have no clue about scrolling
# from: https://github.com/tmux/tmux/issues/1610#issuecomment-504424608
bind-key -T root WheelUpPane \
if -Ft= "#{?pane_active,0,1}" "select-pane" \
    "if -Ft= \"#{mouse_any_flag}\" \
    \"send -M\" \
    \"if -Ft= '#{alternate_on}' \
        'send -N 1 Up' 'copy-mode -e' \""

bind-key -T root WheelDownPane \
    if -Ft= "#{?pane_active,0,1}" "select-pane" \
        "if -Ft= \"#{mouse_any_flag}\" \
            \"send -M\" \
            \"if -Ft= '#{alternate_on}' \
                'send -N 1 Down' '' \""

set-option -w -g mode-keys vi

# scroll in copy mode
bind-key -T copy-mode-vi WheelUpPane select-pane \; send-keys -X -N 1 scroll-up
bind-key -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 1 scroll-down

# ctrl+up/down scrolls to top/bottom line
bind-key -T copy-mode-vi C-Up send -X history-top
bind-key -T copy-mode-vi C-Down send -X history-bottom

# scroll faster with shift
bind-key -T copy-mode-vi S-Up send-keys -N 5 -X cursor-up
bind-key -T copy-mode-vi S-Down send-keys -N 5 -X cursor-down
# scroll super speed with alt+shift
# (see iterm keybindings)
bind-key -T copy-mode-vi S-F9 send-keys -N 10 -X cursor-up    # code: ^[[20;2~
bind-key -T copy-mode-vi S-F10 send-keys -N 10 -X cursor-down # code: ^[[21;2~ mapped to: <alt>+shift>+<down>

# select text without putting it into the clipboard, only do this when then pressing enter
unbind -T copy-mode-vi MouseDragEnd1Pane

# double / tripple click only select, it does not automatically put into clipboard!
bind-key    -T copy-mode-vi DoubleClick1Pane     select-pane \; send-keys -X select-word
bind-key    -T copy-mode-vi TripleClick1Pane     select-pane \; send-keys -X select-line
bind-key    -T root         DoubleClick1Pane     select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" "send -M" "copy-mode ; send -X select-word"
bind-key    -T root         TripleClick1Pane     select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" "send -M" "copy-mode ; send -X select-line"

# map vi copy mode to ctrl+y ctrl+c
unbind-key -T prefix [
bind-key -T prefix C-c copy-mode
# copy mode style
set -g mode-style bg=colour11,fg=colour0
# exit copy mode with ctrl-c
bind-key -T copy-mode-vi C-c send-keys -X cancel
# clear accidental selection with Escape
bind-key -T copy-mode-vi Escape send-keys -X clear-selection
# do not automatically exit copy mode
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe

# do in tmux what cmd+k does in iterm: clear and delete scroll buf
# NOTE: iterm's <cmd>+k is remapped to <cmd>+<shift>+k
#       see SystemPrefs -> Keyboard -> Shortcuts -> App Shortcuts -> iTerm.app -> "Clear Buffer"
bind-key -T root M-F1 send-keys -R C-l \; clear-history # code: ^[[1;3P mapped to: <cmd>+k
bind-key -T root M-F2 clear-history # code: [1;3Q mapped to: <cmd>+<alt>+k

# start search from normal mode
bind-key -T prefix / copy-mode \; command-prompt -p "(search down)" "send -X search-forward-text \"%%%\""
bind-key -T prefix \\ copy-mode \; command-prompt -p "(search regex down)" "send -X search-forward \"%%%\""
# start search from copy mode
bind-key -T copy-mode-vi /  command-prompt -p "(search)" "send -X search-forward-text \"%%%\""
bind-key -T copy-mode-vi \\ command-prompt -p "(search regex)" "send -X search-forward \"%%%\""

# status bar and stuff follows:
#
set -g pane-active-border-style bg=default,fg=colour104
set -g pane-border-style fg=green

set -g status-interval 1

set-option -g status-position top
set -g status-justify left

# check if we have entered the prefix,
#               or are zoomed in,
#               or are in copy mode,
#               or are synchronized,
#               or are in alternate screen mode,
#               or nothing
set-option -w -g status-left "#[bg=black]#{?client_prefix,#[fg=green]●,#{?window_zoomed_flag,#[fg=green]Z,#{?pane_in_mode,#[fg=yellow]⌽,#{?pane_synchronized,#[fg=colour231]#[bg=colour196]●,#{?alternate_on,#[fg=green]≀,≀}}}}}#[default] «#S» "
set -g status-left-length  15
set -g status-right-length 500
set-option -w -g window-status-separator ''
set-option -w -g status-right "#( ~/.tmux/path.sh \"#{pane_current_path}\" \"#{window_width}\" \"#{status-left-length}\" \"#{client_flags}\" \"#{client_key_table}\")"
set-option -w -g status-right-style fg=black,bg=green
# colors are inverted when activity is detected (changed in tmux3.3)
set-option -w -g window-status-format "#{?window_activity_flag,#[fg=green#,bg=colour16#,bold] <#I: #W> ,  #I: #W  }#[default]"
set-option -w -g window-status-current-format "[ #I: #W ]"

set-option -w -g window-status-current-style fg=green,bg=black
set-option -w -g window-status-style fg=black,bg=green
set-option -w -g status-style fg=black,bg=green
set-option -w -g status-right-style fg=black,bg=green
set-option -w -g status-left-style fg=black,bg=white

# monitor acitivty in other windows
set-option -w -g monitor-activity on
set -g activity-action other
# but don't produce a message
set -g visual-activity off

#panes start at 1
set -g pane-base-index 1
# windows start at 1
set -g base-index 1

# handy for testing
bind-key -T prefix C-r source ~/.tmux.conf

# paint status bar gray if focus lost
# NOTE: replaces all other potential hooks
set-hook -g client-focus-out 'set-option -w -g window-status-current-style fg=colour239,bg=colour235 ; \
        set-option -w -g window-status-style fg=colour235,bg=colour239 ; \
        set-option -w -g status-style fg=colour235,bg=colour239; \
        set-option -w -g status-right-style fg=colour235,bg=colour239 ; \
        set-option -w -g status-left-style fg=colour242,bg=colour16 ; \
        set-option -w -g window-status-format "#{?window_activity_flag,#[fg=colour239#,bg=colour235#,bold] <#I: #W> ,  #I: #W  }#[default]" ; \
        set -g pane-active-border-style fg=colour250 ; \
        set -g pane-border-style fg=colour240'

set-hook -g client-focus-in 'set-option -w -g window-status-current-style fg=green,bg=black ; \
        set-option -w -g window-status-style fg=black,bg=green ; \
        set-option -w -g status-style fg=black,bg=green ; \
        set-option -w -g status-right-style fg=black,bg=green ; \
        set-option -w -g status-left-style fg=black,bg=white ; \
        set-option -w -g window-status-format "#{?window_activity_flag,#[fg=green#,bg=colour16#,bold] <#I: #W> ,  #I: #W  }#[default]" ; \
        set -g pane-active-border-style fg=colour104 ; \
        set -g pane-border-style fg=green'


# based on: https://github.com/samoshkin/tmux-config
# disable prefix, switch to table "off", cancel copy mode, run focus hook, disable hooks, refresh status line
# code: ^[[23;2~ mapped to: <cmd>+<esc>
bind-key -T root S-F11 set prefix None \; set key-table off \; if -F '#{pane_in_mode}' 'send-keys -X cancel' \; \
        set-hook -gR client-focus-out \; \
        set-hook client-focus-in ' ' \; \
        set-hook client-focus-out ' ' \; \
        refresh-client -S

bind-key -T off S-F11 set -u prefix \; set -u key-table \; \
        set-hook -u client-focus-in \; \
        set-hook -u client-focus-out \; \
        set-hook -gR client-focus-in \; \
        refresh-client -S

if-shell 'test -n "$SSH_CLIENT"' 'source-file ~/.tmux/.tmux.remote.conf'

# S+F11 in vim
# S+F12 in vim
# M-F3  in zsh
